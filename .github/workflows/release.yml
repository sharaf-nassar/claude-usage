name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            args: ''
          - platform: macos-latest
            args: '--target aarch64-apple-darwin'
          - platform: macos-latest
            args: '--target x86_64-apple-darwin'
          - platform: windows-latest
            args: ''

    runs-on: ${{ matrix.platform }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: lts/*
          cache: npm

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Set version from tag
        if: startsWith(github.ref, 'refs/tags/v')
        shell: bash
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          echo "Setting version to ${VERSION}"
          sed -i.bak -E 's/^version = ".*"/version = "'"${VERSION}"'"/' src-tauri/Cargo.toml
          rm -f src-tauri/Cargo.toml.bak
          node -e "
            const fs = require('fs');
            const p = JSON.parse(fs.readFileSync('package.json'));
            p.version = '${VERSION}';
            fs.writeFileSync('package.json', JSON.stringify(p, null, 2) + '\n');
          "

      - name: Install frontend dependencies
        run: npm install

      - name: Build and release
        uses: tauri-apps/tauri-action@v0.6.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v__VERSION__
          releaseName: 'Claude Usage v__VERSION__'
          releaseBody: 'Download the installer for your platform from the assets below.'
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

  publish:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Rename release assets with platform labels
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          TAG_NAME: ${{ github.ref_name }}
        run: |
          # Find the draft release with retry (API may lag after build)
          RELEASE_ID=""
          for attempt in 1 2 3 4 5; do
            RELEASE_ID=$(gh api "repos/${GH_REPO}/releases" --paginate -q ".[] | select(.tag_name == \"${TAG_NAME}\") | .id" | head -n1)
            if [[ -n "$RELEASE_ID" ]]; then
              break
            fi
            echo "Attempt ${attempt}: release not found yet, waiting 15s..."
            sleep 15
          done
          if [[ -z "$RELEASE_ID" ]]; then
            echo "::error::Could not find release for tag ${TAG_NAME} after 5 attempts"
            exit 1
          fi
          echo "Found release ID: ${RELEASE_ID}"

          # Rename assets: insert platform between version and arch
          gh api "repos/${GH_REPO}/releases/${RELEASE_ID}/assets" --jq '.[] | "\(.id)\t\(.name)"' | while IFS=$'\t' read -r id name; do
            new_name="$name"

            if [[ "$name" == *".AppImage"* ]]; then
              new_name=$(echo "$name" | sed -E 's/(_[0-9]+\.[0-9]+\.[0-9]+)_/\1_linux_/')
            elif [[ "$name" == *".app.tar.gz"* ]] || [[ "$name" == *".dmg"* ]]; then
              new_name=$(echo "$name" | sed -E 's/(_[0-9]+\.[0-9]+\.[0-9]+)_/\1_macOS_/')
            elif [[ "$name" == *".exe"* ]] || [[ "$name" == *".nsis"* ]] || [[ "$name" == *".msi"* ]]; then
              new_name=$(echo "$name" | sed -E 's/(_[0-9]+\.[0-9]+\.[0-9]+)_/\1_windows_/')
            fi

            if [[ "$new_name" != "$name" ]]; then
              echo "Renaming: $name -> $new_name"
              gh api --method PATCH "repos/${GH_REPO}/releases/assets/${id}" -f name="$new_name"
            fi
          done

          # Update latest.json URLs to match renamed filenames
          LATEST_ID=$(gh api "repos/${GH_REPO}/releases/${RELEASE_ID}/assets" --jq '.[] | select(.name == "latest.json") | .id')
          if [[ -n "$LATEST_ID" ]]; then
            gh api "repos/${GH_REPO}/releases/assets/${LATEST_ID}" \
              -H "Accept: application/octet-stream" > latest.json

            sed -i -E 's/(_[0-9]+\.[0-9]+\.[0-9]+)_(.*\.AppImage)/\1_linux_\2/g' latest.json
            sed -i -E 's/(_[0-9]+\.[0-9]+\.[0-9]+)_(.*\.app\.tar\.gz)/\1_macOS_\2/g' latest.json
            sed -i -E 's/(_[0-9]+\.[0-9]+\.[0-9]+)_(.*\.dmg)/\1_macOS_\2/g' latest.json
            sed -i -E 's/(_[0-9]+\.[0-9]+\.[0-9]+)_(.*\.exe)/\1_windows_\2/g' latest.json
            sed -i -E 's/(_[0-9]+\.[0-9]+\.[0-9]+)_(.*\.nsis)/\1_windows_\2/g' latest.json
            sed -i -E 's/(_[0-9]+\.[0-9]+\.[0-9]+)_(.*\.msi)/\1_windows_\2/g' latest.json

            gh api --method DELETE "repos/${GH_REPO}/releases/assets/${LATEST_ID}"
            gh release upload "${TAG_NAME}" latest.json --clobber
          fi

      - name: Publish release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          TAG_NAME: ${{ github.ref_name }}
        run: gh release edit "$TAG_NAME" --draft=false
